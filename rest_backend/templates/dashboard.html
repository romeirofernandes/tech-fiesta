<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IoT Sensor Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Courier New', monospace;
            background-color: #fff;
            color: #000;
            padding: 20px;
            line-height: 1.6;
        }
        
        h1 {
            text-align: center;
            border-bottom: 2px solid #000;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        
        h2 {
            border-bottom: 1px solid #000;
            padding-bottom: 5px;
            margin: 20px 0 10px 0;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .status-bar {
            background-color: #f0f0f0;
            border: 1px solid #000;
            padding: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .status-bar .status {
            font-weight: bold;
        }
        
        .status-bar .status.connected {
            color: #000;
        }
        
        .status-bar .status.error {
            color: #000;
            text-decoration: underline;
        }
        
        .section {
            border: 1px solid #000;
            margin-bottom: 20px;
            padding: 15px;
        }
        
        .current-reading {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .reading-card {
            border: 1px solid #000;
            padding: 15px;
            text-align: center;
        }
        
        .reading-card .label {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 5px;
        }
        
        .reading-card .value {
            font-size: 32px;
            font-weight: bold;
        }
        
        .reading-card .unit {
            font-size: 14px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        
        th, td {
            border: 1px solid #000;
            padding: 8px;
            text-align: left;
        }
        
        th {
            background-color: #f0f0f0;
            font-weight: bold;
        }
        
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        .no-data {
            text-align: center;
            padding: 20px;
            color: #666;
            font-style: italic;
        }
        
        .refresh-info {
            text-align: center;
            font-size: 12px;
            color: #666;
            margin-top: 20px;
        }
        
        .animal-info {
            background-color: #f0f0f0;
            padding: 10px;
            margin-bottom: 10px;
        }
        
        button {
            background-color: #fff;
            border: 1px solid #000;
            padding: 8px 16px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
        }
        
        button:hover {
            background-color: #f0f0f0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>IoT SENSOR DASHBOARD</h1>
        
        <div class="status-bar">
            <div>
                <span>API Status: </span>
                <span id="api-status" class="status">Checking...</span>
            </div>
            <div>
                <span>Last Updated: </span>
                <span id="last-updated">--</span>
            </div>
            <button onclick="refreshData()">REFRESH</button>
        </div>
        
        <!-- Current RFID User Section -->
        <div class="section">
            <h2>CURRENT RFID USER</h2>
            <div id="current-rfid-info">
                <p class="no-data">No RFID card detected yet</p>
            </div>
        </div>
        
        <!-- Latest Sensor Readings Section -->
        <div class="section">
            <h2>LATEST SENSOR READINGS</h2>
            <div id="latest-readings" class="current-reading">
                <div class="reading-card">
                    <div class="label">Temperature</div>
                    <div class="value" id="temp-value">--</div>
                    <div class="unit">Celsius</div>
                </div>
                <div class="reading-card">
                    <div class="label">Humidity</div>
                    <div class="value" id="humidity-value">--</div>
                    <div class="unit">Percent</div>
                </div>
                <div class="reading-card">
                    <div class="label">Heart Rate</div>
                    <div class="value" id="hr-value">--</div>
                    <div class="unit">BPM</div>
                </div>
                <div class="reading-card">
                    <div class="label">RFID Tag</div>
                    <div class="value" id="rfid-value" style="font-size: 16px;">--</div>
                    <div class="unit">Current User</div>
                </div>
            </div>
        </div>
        
        <!-- Recent Sensor Readings History -->
        <div class="section">
            <h2>SENSOR READINGS HISTORY</h2>
            <div id="readings-history">
                <table>
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>RFID Tag</th>
                            <th>Animal</th>
                            <th>Temperature (C)</th>
                            <th>Humidity (%)</th>
                            <th>Heart Rate (BPM)</th>
                        </tr>
                    </thead>
                    <tbody id="readings-table-body">
                        <tr>
                            <td colspan="6" class="no-data">Loading data...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- RFID Events Section -->
        <div class="section">
            <h2>RFID SCAN EVENTS</h2>
            <div id="rfid-events">
                <table>
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>RFID Tag</th>
                            <th>Animal Name</th>
                            <th>Reader ID</th>
                        </tr>
                    </thead>
                    <tbody id="rfid-table-body">
                        <tr>
                            <td colspan="4" class="no-data">Loading data...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Registered Animals Section -->
        <div class="section">
            <h2>REGISTERED ANIMALS</h2>
            <div id="animals-list">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>RFID Tag</th>
                            <th>Name</th>
                            <th>Species</th>
                            <th>Breed</th>
                            <th>Created</th>
                        </tr>
                    </thead>
                    <tbody id="animals-table-body">
                        <tr>
                            <td colspan="6" class="no-data">Loading data...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <div class="refresh-info">
            Real-time updates via WebSocket | Historical data refreshed every 10 seconds | Django REST API + Channels
        </div>
    </div>
    
    <script>
        const API_BASE = 'http://127.0.0.1:8000/api/iot';
        const WS_URL = 'ws://127.0.0.1:8000/ws/sensors/';
        
        let websocket = null;
        let reconnectInterval = null;
        
        // Format timestamp
        function formatTimestamp(timestamp) {
            if (!timestamp) return '--';
            const date = new Date(timestamp);
            return date.toLocaleString();
        }
        
        // Update API status
        function updateStatus(connected, message) {
            const statusEl = document.getElementById('api-status');
            statusEl.textContent = message;
            statusEl.className = connected ? 'status connected' : 'status error';
        }
        
        // Update last updated time
        function updateLastUpdated() {
            document.getElementById('last-updated').textContent = new Date().toLocaleTimeString();
        }
        
        // Initialize WebSocket connection
        function connectWebSocket() {
            console.log('Connecting to WebSocket...');
            websocket = new WebSocket(WS_URL);
            
            websocket.onopen = function(event) {
                console.log('WebSocket connected');
                updateStatus(true, 'CONNECTED (WebSocket)');
                if (reconnectInterval) {
                    clearInterval(reconnectInterval);
                    reconnectInterval = null;
                }
            };
            
            websocket.onmessage = function(event) {
                const message = JSON.parse(event.data);
                console.log('WebSocket message:', message);
                
                if (message.type === 'initial_data') {
                    // Handle initial data load
                    handleInitialData(message.data);
                } else if (message.type === 'sensor_update') {
                    // Handle real-time sensor update
                    handleSensorUpdate(message.data);
                }
                
                updateLastUpdated();
            };
            
            websocket.onerror = function(error) {
                console.error('WebSocket error:', error);
                updateStatus(false, 'ERROR');
            };
            
            websocket.onclose = function(event) {
                console.log('WebSocket disconnected');
                updateStatus(false, 'DISCONNECTED');
                websocket = null;
                
                // Only reconnect if page is visible and not manually closed
                if (!reconnectInterval && !document.hidden) {
                    reconnectInterval = setInterval(function() {
                        if (!document.hidden && !websocket) {
                            console.log('Attempting to reconnect...');
                            connectWebSocket();
                        }
                    }, 5000);  // Increased to 5 seconds
                }
            };
        }
        
        // Handle initial data from WebSocket
        function handleInitialData(data) {
            if (data && data.length > 0) {
                const latest = data[0];
                updateLatestReadings(latest);
            }
            // Still fetch other data via HTTP on initial load
            fetchRFIDEvents();
            fetchAnimals();
        }
        
        // Handle real-time sensor updates
        function handleSensorUpdate(data) {
            console.log('âœ… Real-time sensor update via WebSocket:', data);
            updateLatestReadings(data);
            
            // WebSocket provides real-time data - no need to poll!
            // Only refresh RFID events occasionally (not every message)
            if (Math.random() < 0.1) {  // 10% chance to refresh on each update
                fetchRFIDEvents();
            }
        }
        
        // Update latest readings cards
        function updateLatestReadings(data) {
            document.getElementById('temp-value').textContent = 
                data.temperature !== null && data.temperature !== undefined ? parseFloat(data.temperature).toFixed(1) : '--';
            document.getElementById('humidity-value').textContent = 
                data.humidity !== null && data.humidity !== undefined ? parseFloat(data.humidity).toFixed(1) : '--';
            document.getElementById('hr-value').textContent = 
                data.heart_rate !== null && data.heart_rate !== undefined ? data.heart_rate : '--';
            document.getElementById('rfid-value').textContent = 
                data.rfid_tag || '--';
            
            // Update current RFID info
            if (data.rfid_tag) {
                document.getElementById('current-rfid-info').innerHTML = `
                    <div class="animal-info">
                        <p><strong>RFID Tag:</strong> ${data.rfid_tag}</p>
                        <p><strong>Animal:</strong> ${data.animal_name || 'Not linked'}</p>
                        <p><strong>Species:</strong> ${data.animal_species || 'Unknown'}</p>
                        <p><strong>Last Reading:</strong> ${formatTimestamp(data.timestamp)}</p>
                    </div>
                `;
            }
        }
        
        // Fetch sensor readings
        async function fetchSensorReadings() {
            try {
                const response = await fetch(`${API_BASE}/sensors/latest/?limit=20`);
                if (!response.ok) throw new Error('Failed to fetch sensors');
                const data = await response.json();
                
                // Update latest readings cards
                if (data.length > 0) {
                    const latest = data[0];
                    document.getElementById('temp-value').textContent = 
                        latest.temperature !== null ? parseFloat(latest.temperature).toFixed(1) : '--';
                    document.getElementById('humidity-value').textContent = 
                        latest.humidity !== null ? parseFloat(latest.humidity).toFixed(1) : '--';
                    document.getElementById('hr-value').textContent = 
                        latest.heart_rate !== null ? latest.heart_rate : '--';
                    document.getElementById('rfid-value').textContent = 
                        latest.rfid_tag || '--';
                    
                    // Update current RFID info
                    if (latest.rfid_tag) {
                        document.getElementById('current-rfid-info').innerHTML = `
                            <div class="animal-info">
                                <p><strong>RFID Tag:</strong> ${latest.rfid_tag}</p>
                                <p><strong>Animal:</strong> ${latest.animal_name || 'Not linked'}</p>
                                <p><strong>Species:</strong> ${latest.animal_species || 'Unknown'}</p>
                                <p><strong>Last Reading:</strong> ${formatTimestamp(latest.timestamp)}</p>
                            </div>
                        `;
                    }
                }
                
                // Update readings table
                const tbody = document.getElementById('readings-table-body');
                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="no-data">No sensor readings yet</td></tr>';
                } else {
                    tbody.innerHTML = data.map(reading => `
                        <tr>
                            <td>${formatTimestamp(reading.timestamp)}</td>
                            <td>${reading.rfid_tag || '--'}</td>
                            <td>${reading.animal_name || '--'}</td>
                            <td>${reading.temperature !== null ? parseFloat(reading.temperature).toFixed(1) : '--'}</td>
                            <td>${reading.humidity !== null ? parseFloat(reading.humidity).toFixed(1) : '--'}</td>
                            <td>${reading.heart_rate !== null ? reading.heart_rate : '--'}</td>
                        </tr>
                    `).join('');
                }
                
                return true;
            } catch (error) {
                console.error('Error fetching sensor readings:', error);
                return false;
            }
        }
        
        // Fetch RFID events
        async function fetchRFIDEvents() {
            try {
                const response = await fetch(`${API_BASE}/rfid/`);
                if (!response.ok) throw new Error('Failed to fetch RFID events');
                const data = await response.json();
                
                const tbody = document.getElementById('rfid-table-body');
                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="no-data">No RFID events yet</td></tr>';
                } else {
                    // Show last 10 events
                    tbody.innerHTML = data.slice(0, 10).map(event => `
                        <tr>
                            <td>${formatTimestamp(event.timestamp)}</td>
                            <td>${event.rfid_tag || '--'}</td>
                            <td>${event.animal_name || '--'}</td>
                            <td>${event.reader_id || '--'}</td>
                        </tr>
                    `).join('');
                }
                
                return true;
            } catch (error) {
                console.error('Error fetching RFID events:', error);
                return false;
            }
        }
        
        // Fetch animals
        async function fetchAnimals() {
            try {
                const response = await fetch(`${API_BASE}/animals/`);
                if (!response.ok) throw new Error('Failed to fetch animals');
                const data = await response.json();
                
                const tbody = document.getElementById('animals-table-body');
                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="no-data">No animals registered yet</td></tr>';
                } else {
                    tbody.innerHTML = data.map(animal => `
                        <tr>
                            <td>${animal.id}</td>
                            <td>${animal.rfid_tag || '--'}</td>
                            <td>${animal.name || '--'}</td>
                            <td>${animal.species || '--'}</td>
                            <td>${animal.breed || '--'}</td>
                            <td>${formatTimestamp(animal.created_at)}</td>
                        </tr>
                    `).join('');
                }
                
                return true;
            } catch (error) {
                console.error('Error fetching animals:', error);
                return false;
            }
        }
        
        // Health check
        async function healthCheck() {
            try {
                const response = await fetch(`${API_BASE}/health/`);
                if (response.ok) {
                    updateStatus(true, 'CONNECTED');
                    return true;
                }
            } catch (error) {
                updateStatus(false, 'DISCONNECTED');
                return false;
            }
        }
        
        // Refresh all data
        async function refreshData() {
            // WebSocket handles real-time sensor data
            // We only need to fetch historical data via HTTP
            await Promise.all([
                fetchSensorReadings(),
                fetchRFIDEvents(),
                fetchAnimals()
            ]);
            updateLastUpdated();
        }
        
        // Initial load
        connectWebSocket();
        refreshData();
        
        // Cleanup WebSocket on page unload
        window.addEventListener('beforeunload', function() {
            if (websocket) {
                websocket.close();
            }
            if (reconnectInterval) {
                clearInterval(reconnectInterval);
            }
        });
        
        // Refresh historical data less frequently (WebSocket handles real-time sensor data)
        setInterval(function() {
            if (!document.hidden) {
                fetchRFIDEvents();
                fetchAnimals();
                // Sensor readings come via WebSocket, no polling needed!
            }
        }, 30000);  // Every 30 seconds for historical data only
    </script>
</body>
</html>
